.PHONY: help install setup run dev test clean load-data generate-embeddings create-indexes security-check docs

# Variables
PYTHON := python3
VENV := venv
BIN := $(VENV)/bin
ACTIVATE := . $(BIN)/activate

help: ## Muestra esta ayuda
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘           RAG MongoDB Atlas - Comandos Disponibles           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

install: ## Instalar dependencias
	@echo "ğŸ“¦ Instalando dependencias..."
	$(PYTHON) -m venv $(VENV)
	$(ACTIVATE) && pip install --upgrade pip
	$(ACTIVATE) && pip install -r requirements.txt
	@echo "âœ… Dependencias instaladas"

setup: install ## ConfiguraciÃ³n inicial completa
	@echo "ğŸ”§ Configurando proyecto..."
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âš ï¸  Archivo .env creado. Por favor configura tus credenciales."; \
	else \
		echo "âœ… Archivo .env ya existe"; \
	fi
	$(ACTIVATE) && python scripts/init_db.py
	$(ACTIVATE) && python scripts/create_indexes.py
	@echo "âœ… ConfiguraciÃ³n completada"

run: ## Ejecutar servidor (producciÃ³n)
	@echo "ğŸš€ Iniciando servidor..."
	$(ACTIVATE) && uvicorn main:app --host 0.0.0.0 --port 8000

dev: ## Ejecutar servidor en modo desarrollo (auto-reload)
	@echo "ğŸ”„ Iniciando servidor en modo desarrollo..."
	$(ACTIVATE) && uvicorn main:app --host 0.0.0.0 --port 8000 --reload

test: ## Ejecutar tests
	@echo "ğŸ§ª Ejecutando tests..."
	$(ACTIVATE) && pytest tests/ -v

clean: ## Limpiar archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.log" -delete
	rm -rf .pytest_cache
	@echo "âœ… Limpieza completada"

load-data: ## Cargar datos de ejemplo a MongoDB
	@echo "ğŸ“Š Cargando datos..."
	$(ACTIVATE) && python scripts/load_data.py

generate-embeddings: ## Generar embeddings para documentos
	@echo "ğŸ§  Generando embeddings..."
	$(ACTIVATE) && python scripts/generate_embeddings.py

create-indexes: ## Crear Ã­ndices en MongoDB
	@echo "ğŸ“‡ Creando Ã­ndices..."
	$(ACTIVATE) && python scripts/create_indexes.py

security-check: ## Verificar seguridad del repositorio
	@echo "ğŸ”’ Verificando seguridad..."
	@./verify_security.sh

docs: ## Abrir documentaciÃ³n de la API
	@echo "ğŸ“– Abriendo documentaciÃ³n..."
	@echo "API Docs: http://localhost:8000/docs"
	@echo "ReDoc: http://localhost:8000/redoc"

status: ## Ver estado de la aplicaciÃ³n
	@echo "ğŸ“Š Estado de la aplicaciÃ³n:"
	@echo ""
	@if [ -d "$(VENV)" ]; then \
		echo "âœ… Entorno virtual: Instalado"; \
	else \
		echo "âŒ Entorno virtual: No instalado (ejecuta 'make install')"; \
	fi
	@if [ -f ".env" ]; then \
		echo "âœ… Archivo .env: Configurado"; \
	else \
		echo "âŒ Archivo .env: No existe (ejecuta 'make setup')"; \
	fi
	@echo ""

quickstart: setup load-data generate-embeddings ## Inicio rÃ¡pido: configurar + cargar datos + generar embeddings
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                âœ… CONFIGURACIÃ“N COMPLETADA                    â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "PrÃ³ximos pasos:"
	@echo "1. Crear Ã­ndices vectoriales en MongoDB Atlas UI"
	@echo "2. Ejecutar: make dev"
	@echo "3. Abrir: http://localhost:8000/docs"
	@echo ""
